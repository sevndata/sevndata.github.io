<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    

    
<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>
    

<meta charset="utf-8" >

<title>基于Spring Boot Actuator制作炫酷可视化系统监控</title>
<meta name="keywords" content="基于Spring Boot Actuator制作炫酷可视化系统监控, sevndata">
<meta name="description" content="分享基于`Spring Boot Actuator`制作炫酷可视化系统监控，其中使用到了`Prometheus`，`Grafana`">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="基于Spring Boot Actuator制作炫酷可视化系统监控">
<meta property="og:description" content="分享基于`Spring Boot Actuator`制作炫酷可视化系统监控，其中使用到了`Prometheus`，`Grafana`">

<link rel="shortcut icon" href="/image/logo.jpg">
<link rel="stylesheet" href="/style/main.css">

  <!-- hexo injector head_end start --><script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.esm.min.mjs">
    mermaid.initialize(
      startOnLoad: true,
    );
    </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="http://sevndata.com">
        <img class="avatar" src="/image/logo.jpg" alt="logo" width="32px" height="32px">
      </a>
      <a href="http://sevndata.com">
        <h1 class="site-title">sevndata</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        首页
      </a>
    
  
    
      <a href="/tags" class="menu purple-link">
        标签
      </a>
    
  
    
      <a href="/categories" class="menu purple-link">
        分类
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        关于
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">基于Spring Boot Actuator制作炫酷可视化系统监控</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2020-08-31</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/Grafana/">
              Grafana
                
                  ，
                
              </a>
            
              <a href="/tags/Actuator/">
              Actuator
                
                  ，
                
              </a>
            
              <a href="/tags/Prometheus/">
              Prometheus
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <p>分享基于<code>Spring Boot Actuator</code>制作炫酷可视化系统监控，其中使用到了<code>Prometheus</code>，<code>Grafana</code>。</p>
<span id="more"></span>

<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><ol>
<li><p><code>Spring Boot Actuator</code>是一个采集应用内部信息并暴露给外部的模块,它可以帮助我们监控和管理<code>Spring Boot</code>应用。</p>
</li>
<li><p><code>Prometheus</code>是由<code>SoundCloud</code>开发的开源监控报警系统和时序列数据库，我们还可以选用其他工具如：<code>AppOptics</code>,<code>Atlas</code>,<code>JMX</code>等，更多支持可查阅<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready">Spring Boot Actuator文档</a>。</p>
</li>
<li><p><code>Grafana</code>是一个跨平台的开源的度量分析和可视化工具,可以通过将采集的数据查询然后可视化的展示,并及时通知。</p>
</li>
</ol>
<p>在下文中，我们将利用这三个工具制作炫酷可视化系统监控，查阅文档分别为：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready">Spring Boot Actuator文档</a>，<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/2.3.4.RELEASE/actuator-api/html/">Spring Boot Actuator数据文档</a>，<a target="_blank" rel="noopener" href="https://micrometer.io/docs/registry/prometheus">Prometheus引入文档</a>，<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/getting_started/?__cf_chl_captcha_tk__=b792618af602f67bdd94ccaf08839dd5cfac2068-1603764581-0-AdDJqe86JGdz12O1xVpzo_FLocxdk0a9FkNcW53_n0CKyLnbAOsF8bsTNgbS0bdqrKEc4ie8JowlO6Ds4GvnXmAkuKcMyPSPD51Wg2rZ0oALUFUA5WeNStAd-VOmA3TeIJf7rKVaWaYCKB0TbiOIIxCfo7W2evTCePxIRk4ZqcJaZIr-C9LcDH62LncGb0KMdlcUwnU20a1wVq9qwB3Yc05l_viKqv72qj90eGXdz_5TbR6mo86tREGL9F05Hg15JWp86y8xGURSA-ackFt8Y9nDZjFEDrMQ6qZw-dowGPSypLl5EHT9azR6qFP23VKJrpEAQXh3SXd8UoJTfSSAq-HFXMsINhKUO-g_a5-l1e9neQLGA9URT4pqYaSJSP7fWiLcdmSDwg-imyDp6DpYYQef4N5-u1tIA6jjbAL6wO1Ds61nqX_1zFXzvZ4rejZFS_tZ2EG26-rkvX_ul0KWXXdr4hPczboSJLUTPQfS7y9BknxMTQhFH9HW6Es8sKYwyovscHUYXDqRDM4-ZtaEhWqxS4nNvNKv3T2PEu0g5RVC">Prometheus安装文档</a>，<a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/installation/rpm/">Grafana安装文档</a></p>
<h2 id="2-Spring-Boot-Actuator"><a href="#2-Spring-Boot-Actuator" class="headerlink" title="2. Spring Boot Actuator"></a>2. Spring Boot Actuator</h2><h3 id="1-引入"><a href="#1-引入" class="headerlink" title="1. 引入"></a>1. 引入</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- for maven --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//for gradle</span>
dependencies <span class="token punctuation">&#123;</span>
    implementation 'org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">:</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>actuator'
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//启用禁止</span>
management<span class="token punctuation">.</span>endpoint<span class="token punctuation">.</span>shutdown<span class="token punctuation">.</span>enabled<span class="token operator">=</span><span class="token boolean">true</span>
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>enabled<span class="token operator">-</span>by<span class="token operator">-</span><span class="token keyword">default</span><span class="token operator">=</span><span class="token boolean">false</span>
<span class="token comment">//暴露接口</span>
management<span class="token punctuation">.</span>endpoint<span class="token punctuation">.</span>info<span class="token punctuation">.</span>enabled<span class="token operator">=</span><span class="token boolean">true</span>
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>jmx<span class="token punctuation">.</span>exposure<span class="token punctuation">.</span>include<span class="token operator">=</span>health<span class="token punctuation">,</span>info
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>web<span class="token punctuation">.</span>exposure<span class="token punctuation">.</span>include<span class="token operator">=</span><span class="token operator">*</span>
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>web<span class="token punctuation">.</span>exposure<span class="token punctuation">.</span>exclude<span class="token operator">=</span>env<span class="token punctuation">,</span>beans
<span class="token comment">//缓存时间</span>
management<span class="token punctuation">.</span>endpoint<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>time<span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>live<span class="token operator">=</span><span class="token number">10</span>s
<span class="token comment">//CORS支持</span>
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>web<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allowed<span class="token operator">-</span>origins<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>web<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allowed<span class="token operator">-</span>methods<span class="token operator">=</span><span class="token constant">GET</span><span class="token punctuation">,</span><span class="token constant">POST</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>设置数据接口权限</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActuatorSecurity</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
      http<span class="token punctuation">.</span><span class="token function">requestMatcher</span><span class="token punctuation">(</span><span class="token class-name">EndpointRequest</span><span class="token punctuation">.</span><span class="token function">toAnyEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span> <span class="token operator">-></span>
          requests<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>自定义数据接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@ReadOperation</span>
<span class="token keyword">public</span> <span class="token class-name">CustomData</span> <span class="token function">getCustomData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomData</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-通过HTTP获取数据"><a href="#3-通过HTTP获取数据" class="headerlink" title="3. 通过HTTP获取数据"></a>3. 通过<code>HTTP</code>获取数据</h3><p><code>Spring Boot Actuator</code>会自动配置所有启用的接口并通过<code>HTTP</code>公开。默认使用id前缀为的端点的<code>/Actuator</code>作为URL路径。例如，<code>health</code>暴露为<code>/Actuator/health</code>。他会使用<code>Spring MVC</code>,<code>Jackson</code>。</p>
<h3 id="4-指标数据内容"><a href="#4-指标数据内容" class="headerlink" title="4. 指标数据内容"></a>4. 指标数据内容</h3><p>从<code>HTTP</code>接口获取到为<code>json</code>格式的数据。具体详细含义可查阅<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/2.3.4.RELEASE/actuator-api/html/">Spring Boot Actuator数据文档</a>。<br>例如获取<code>health</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token string">'http://localhost:8080/Actuator/health'</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> GET <span class="token parameter variable">-H</span> <span class="token string">'Accept: application/json'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"UP"</span><span class="token punctuation">,</span>
  <span class="token property">"components"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"broker"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"UP"</span><span class="token punctuation">,</span>
      <span class="token property">"components"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"us1"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"UP"</span><span class="token punctuation">,</span>
          <span class="token property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"version"</span> <span class="token operator">:</span> <span class="token string">"1.0.2"</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"us2"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"UP"</span><span class="token punctuation">,</span>
          <span class="token property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"version"</span> <span class="token operator">:</span> <span class="token string">"1.0.4"</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"db"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"UP"</span><span class="token punctuation">,</span>
      <span class="token property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"database"</span> <span class="token operator">:</span> <span class="token string">"H2"</span><span class="token punctuation">,</span>
        <span class="token property">"validationQuery"</span> <span class="token operator">:</span> <span class="token string">"isValid()"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"diskSpace"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"UP"</span><span class="token punctuation">,</span>
      <span class="token property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token number">194687758336</span><span class="token punctuation">,</span>
        <span class="token property">"free"</span> <span class="token operator">:</span> <span class="token number">92457164800</span><span class="token punctuation">,</span>
        <span class="token property">"threshold"</span> <span class="token operator">:</span> <span class="token number">10485760</span><span class="token punctuation">,</span>
        <span class="token property">"exists"</span> <span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-Prometheus"><a href="#3-Prometheus" class="headerlink" title="3. Prometheus"></a>3. Prometheus</h2><h3 id="1-引入-1"><a href="#1-引入-1" class="headerlink" title="1. 引入"></a>1. 引入</h3><ol>
<li><p><code>maven</code>引入</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--for maven--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.micrometer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>micrometer-registry-prometheus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;micrometer.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>暴露数据接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>web<span class="token punctuation">.</span>exposure<span class="token punctuation">.</span>include<span class="token operator">=</span><span class="token operator">*</span>
management<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>application<span class="token operator">=</span>$<span class="token punctuation">&#123;</span>spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


</li>
</ol>
<h3 id="2-配置-1"><a href="#2-配置-1" class="headerlink" title="2. 配置"></a>2. 配置</h3><p>在Spring Boot环境中下自动配置Prometheus接口。否则，可以使用任何基于JVM的HTTP服务器实现来将数据公开给Prometheus。</p>
<p>在Spring Boot中使用<code>MeterRegistryCustomizer</code>自动注册配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">MeterRegistryCustomizer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MeterRegistry</span><span class="token punctuation">></span></span> <span class="token function">metricsCommonTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> registry <span class="token operator">-></span> registry<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commonTags</span><span class="token punctuation">(</span><span class="token string">"application"</span><span class="token punctuation">,</span> <span class="token string">"MYAPPNAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其他环境可参考下面示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//com.sun.net.httpserver.HttpServer</span>
<span class="token class-name">PrometheusMeterRegistry</span> prometheusRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrometheusMeterRegistry</span><span class="token punctuation">(</span><span class="token class-name">PrometheusConfig</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">HttpServer</span> server <span class="token operator">=</span> <span class="token class-name">HttpServer</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token string">"/prometheus"</span><span class="token punctuation">,</span> httpExchange <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> response <span class="token operator">=</span> prometheusRegistry<span class="token punctuation">.</span><span class="token function">scrape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        httpExchange<span class="token punctuation">.</span><span class="token function">sendResponseHeaders</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">OutputStream</span> os <span class="token operator">=</span> httpExchange<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>server<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更加详细的内容查阅<a target="_blank" rel="noopener" href="https://micrometer.io/docs/registry/prometheus">Prometheus引入文档</a></p>
<h3 id="3-安装"><a href="#3-安装" class="headerlink" title="3. 安装"></a>3. 安装</h3><ol>
<li><p>下载最新的安装包。并安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/prometheus/prometheus/releases/download/v2.22.0/prometheus-2.22.0.linux-amd64.tar.gz
<span class="token function">tar</span> xvfz prometheus-2.22.tar.gz
<span class="token builtin class-name">cd</span> prometheus-2.22<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置文件<code>prometheus.yml</code>。<br>注意<code>GitLab</code>或者其他软件也使用到了<code>Prometheus</code>，修改端口号解决问题。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">global:
  scrape_interval:     15s <span class="token comment"># By default, scrape targets every 15 seconds.</span>

  <span class="token comment"># Attach these labels to any time series or alerts when communicating with</span>
  <span class="token comment"># external systems (federation, remote storage, Alertmanager).</span>
  external_labels:
    monitor: <span class="token string">'codelab-monitor'</span>

<span class="token comment"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="token comment"># Here it's Prometheus itself.</span>
scrape_configs:
  <span class="token comment"># The job name is added as a label `job=&lt;job_name>` to any timeseries scraped from this config.</span>
  - job_name: <span class="token string">'prometheus'</span>

    <span class="token comment"># Override the global default and scrape targets from this job every 5 seconds.</span>
    scrape_interval: 5s

    static_configs:
      - targets: <span class="token punctuation">[</span><span class="token string">'localhost:9090'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-job_name: <span class="token string">'Prometheus'</span> <span class="token comment">#应用部署机器上的应用名</span>
-targets: <span class="token punctuation">[</span><span class="token string">'127.0.0.1:9090'</span><span class="token punctuation">]</span> <span class="token comment">#应用运行机器上的本机端口号本机ip</span>

-job_name: <span class="token string">'SpringBoot_Prometheus'</span> <span class="token comment">#SpringBoot的应用名</span>
metrics_path: <span class="token string">'/actuator/prometheus'</span> <span class="token comment">#能获取节点信息的路径</span>
-targets: <span class="token punctuation">[</span><span class="token string">'192.168.159.1:8080'</span><span class="token punctuation">]</span> <span class="token comment">#SpringBoot应用运行的机器的ip端口号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Start Prometheus.</span>
<span class="token comment"># By default, Prometheus stores its database in ./data (flag --storage.tsdb.path).</span>
./prometheus <span class="token parameter variable">--config.file</span><span class="token operator">=</span>prometheus.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

</li>
</ol>
<p>更加详细的内容查阅<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/getting_started/?__cf_chl_captcha_tk__=b792618af602f67bdd94ccaf08839dd5cfac2068-1603764581-0-AdDJqe86JGdz12O1xVpzo_FLocxdk0a9FkNcW53_n0CKyLnbAOsF8bsTNgbS0bdqrKEc4ie8JowlO6Ds4GvnXmAkuKcMyPSPD51Wg2rZ0oALUFUA5WeNStAd-VOmA3TeIJf7rKVaWaYCKB0TbiOIIxCfo7W2evTCePxIRk4ZqcJaZIr-C9LcDH62LncGb0KMdlcUwnU20a1wVq9qwB3Yc05l_viKqv72qj90eGXdz_5TbR6mo86tREGL9F05Hg15JWp86y8xGURSA-ackFt8Y9nDZjFEDrMQ6qZw-dowGPSypLl5EHT9azR6qFP23VKJrpEAQXh3SXd8UoJTfSSAq-HFXMsINhKUO-g_a5-l1e9neQLGA9URT4pqYaSJSP7fWiLcdmSDwg-imyDp6DpYYQef4N5-u1tIA6jjbAL6wO1Ds61nqX_1zFXzvZ4rejZFS_tZ2EG26-rkvX_ul0KWXXdr4hPczboSJLUTPQfS7y9BknxMTQhFH9HW6Es8sKYwyovscHUYXDqRDM4-ZtaEhWqxS4nNvNKv3T2PEu0g5RVC">Prometheus安装文档</a></p>
<h2 id="4-Grafana"><a href="#4-Grafana" class="headerlink" title="4. Grafana"></a>4. Grafana</h2><h3 id="1-添加源-etc-yum-repos-d-grafana-repo"><a href="#1-添加源-etc-yum-repos-d-grafana-repo" class="headerlink" title="1. 添加源/etc/yum.repos.d/grafana.repo"></a>1. 添加源<code>/etc/yum.repos.d/grafana.repo</code></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>grafana<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>grafana
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://packages.grafana.com/oss/rpm
<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://packages.grafana.com/gpg.key
<span class="token assign-left variable">sslverify</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">sslcacert</span><span class="token operator">=</span>/etc/pki/tls/certs/ca-bundle.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> grafana<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>更多版本和安装方法查阅<a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/installation/rpm/">Grafana安装文档</a></p>
<h3 id="3-启动"><a href="#3-启动" class="headerlink" title="3. 启动"></a>3. 启动</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl start grafana-server
<span class="token function">sudo</span> systemctl status grafana-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="4-自启动"><a href="#4-自启动" class="headerlink" title="4. 自启动"></a>4. 自启动</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> grafana-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="5-登录"><a href="#5-登录" class="headerlink" title="5. 登录"></a>5. 登录</h3><p>访问<code>http//xxx:3000/</code>，输入用户名<code>admin</code>和密码登录，第一次成功会提示更改密码。<code>3000</code>为<code>Grafana</code>的默认监听端口。</p>
<h3 id="6-绘制监控图"><a href="#6-绘制监控图" class="headerlink" title="6. 绘制监控图"></a>6. 绘制监控图</h3><p>可以在<code>Grafana</code>上设置数据源，自定义模板，导入模板等。这样就可以制作炫酷可视化系统监控了。</p>

        </div>
          
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="top-box-text">1. 概述</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#2-Spring-Boot-Actuator"><span class="top-box-text">2. Spring Boot Actuator</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-%E5%BC%95%E5%85%A5"><span class="top-box-text">1. 引入</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E9%85%8D%E7%BD%AE"><span class="top-box-text">2. 配置</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-%E9%80%9A%E8%BF%87HTTP%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="top-box-text">3. 通过HTTP获取数据</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#4-%E6%8C%87%E6%A0%87%E6%95%B0%E6%8D%AE%E5%86%85%E5%AE%B9"><span class="top-box-text">4. 指标数据内容</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-Prometheus"><span class="top-box-text">3. Prometheus</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-%E5%BC%95%E5%85%A5-1"><span class="top-box-text">1. 引入</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E9%85%8D%E7%BD%AE-1"><span class="top-box-text">2. 配置</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-%E5%AE%89%E8%A3%85"><span class="top-box-text">3. 安装</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#4-Grafana"><span class="top-box-text">4. Grafana</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-%E6%B7%BB%E5%8A%A0%E6%BA%90-etc-yum-repos-d-grafana-repo"><span class="top-box-text">1. 添加源&#x2F;etc&#x2F;yum.repos.d&#x2F;grafana.repo</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-%E5%AE%89%E8%A3%85"><span class="top-box-text">2. 安装</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-%E5%90%AF%E5%8A%A8"><span class="top-box-text">3. 启动</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#4-%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="top-box-text">4. 自启动</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#5-%E7%99%BB%E5%BD%95"><span class="top-box-text">5. 登录</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#6-%E7%BB%98%E5%88%B6%E7%9B%91%E6%8E%A7%E5%9B%BE"><span class="top-box-text">6. 绘制监控图</span></a></li></ol></li></ol>
        </div>
          
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/2020/06/02/js-reactjs-eslint/">
          <h3 class="post-title">
            下一篇：忽略eslint检查
          </h3>
        </a>
      </div>
    
  </div>










<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a aria-label="跳转至github" href="https://github.com/sevndata" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
      
        <a aria-label="跳转至email" href="mailto:sevndata@gmail.com" target="_blank">
          <i class="icon icon-email"></i>
        </a>
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
    
     |
    
      <a href="https://sevndata.com/" target="_blank">© 2023 sevndata.com 版权所有</a>
  
  
  
    
     |
    
      <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh-hans" target="_blank">内容发布遵循 CC-BY-NC-SA 协议</a>
  
  
  
    
     |
    
      <a href="https://sevndata.com/" target="_blank">sevndata@gmail.com</a>
  
  
</div>
</footer>


      </div>
    </div>
    
<script id="hexo-configurations"> window.theme_config = {"image":{"lazyload_enable":true,"photo_zoom":"simple-lightbox"}}; window.is_post = true; </script>

<script src="/js/main.js"></script>






  </body>
</html>

